{"type":"getPostById","data":{"title":"repeat-joker","date":"2022-07-13T16:00:00.000Z","description":"","categories":[{"name":"技术","_id":"cl8x1d8b5000dkw49eu9b2oag"},{"name":"Lua","_id":"cl8x1d8bw0016kw492l4848bz"}],"tags":[{"name":"Dice","_id":"cl8x1d8b4000ckw49a83b91xo"}],"content":"<details class=\"note \"><summary><p>secondary</p>\n</summary>\n<p><strong>目前正在努力ing…</strong></p>\n\n</details>\n\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n<p>使用《署名—非商业性使用—相同方式共享4.0 协议国际版》（CC BY-NC-SA 4.0）进行授权<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9sZWdhbGNvZGUuemgtSGFucw==\">https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-Hans<i class=\"fa fa-external-link-alt\"></i></span></p>\n</blockquote>\n<div class=\"note warning\"><p><strong>WARNING ⚠️</strong><br>提供了dice解决复读问题的一种方法思路，但不免会有诸多不便。</p>\n<blockquote>\n<p>采用读写json方式。</p>\n</blockquote>\n</div>\n\n\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msg_order=&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">&quot;basicFunction&quot;</span>)</span><br><span class=\"line\">json = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;json&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">msg_order[<span class=\"string\">&quot;.repjoker&quot;</span>]=<span class=\"string\">&quot;repjoker&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">default_uid_json = <span class=\"string\">[[&#123;&quot;uid&quot;:2753364619,&quot;msg&quot;:&quot;好耶&quot;,&quot;time&quot;:1657773120&#125;]]</span></span><br><span class=\"line\">default_gid_json = <span class=\"string\">[[&#123;&quot;gid&quot;:971050440,&quot;msg&quot;:&quot;简律纯&quot;,&quot;time&quot;:1657773120&#125;]]</span></span><br><span class=\"line\">uid_path = <span class=\"string\">&quot;plugin//repeat-joker//uid.json&quot;</span></span><br><span class=\"line\">gid_path = <span class=\"string\">&quot;plugin//repeat-joker//gid.json&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(getUserConf(getDiceQQ(),<span class=\"string\">&#x27;repjoker_&#x27;</span>) ~= <span class=\"literal\">true</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    mkDirs(getDiceDir()..<span class=\"string\">&#x27;//plugin//repeat-joker&#x27;</span>)</span><br><span class=\"line\">    write_file(uid_path,default_uid_json)</span><br><span class=\"line\">    write_file(gid_path,default_gid_json)</span><br><span class=\"line\">    setUserConf(getDiceQQ(),<span class=\"string\">&#x27;repjoker_&#x27;</span>,<span class=\"literal\">true</span>)</span><br><span class=\"line\">    <span class=\"comment\">--&gt; repeat-joker:初始化完成~</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">repjoker</span><span class=\"params\">(msg)</span></span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> default_data = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> data = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> son_orders = fitemSort(Match(msg.fromMsg,#<span class=\"string\">&#x27;.repkiller&#x27;</span>+<span class=\"number\">1</span>))</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(fitems[<span class=\"number\">1</span>] == <span class=\"string\">&quot;list&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(fitems[<span class=\"number\">2</span>] == <span class=\"string\">&quot;uid&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">            default_data = <span class=\"string\">&quot;&#123;\\&quot;uid_list\\&quot;:[&quot;</span>..read_file(uid_path)..<span class=\"string\">&quot;]&#125;&quot;</span></span><br><span class=\"line\">            data = json.decode(default_data)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;&#123;self&#125;共【&quot;</span>..#data.uid_list..<span class=\"string\">&quot;】条私聊记录:&quot;</span>..default_data</span><br><span class=\"line\">        <span class=\"keyword\">elseif</span>(fitems[<span class=\"number\">2</span>] == <span class=\"string\">&quot;gid&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">            default_data =  <span class=\"string\">&quot;&#123;\\&quot;gid_list\\&quot;:[&quot;</span>..read_file(gid_path)..<span class=\"string\">&quot;]&#125;&quot;</span></span><br><span class=\"line\">            data =  json.decode(default_data)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;&#123;self&#125;共【&quot;</span>..#data.gid_list..<span class=\"string\">&quot;】条群聊记录:\\n&quot;</span>..default_data</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span>(fitems[<span class=\"number\">1</span>] == <span class=\"string\">&quot;uid&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        default_data = <span class=\"string\">&quot;&#123;\\&quot;uid_list\\&quot;:[&quot;</span>..read_file(uid_path)..<span class=\"string\">&quot;]&#125;&quot;</span></span><br><span class=\"line\">        data = json.decode(default_data)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(fitems[<span class=\"number\">2</span>] == <span class=\"literal\">nil</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(getUserConf(msg.uid,<span class=\"string\">&#x27;uid-help&#x27;</span>) ~= <span class=\"literal\">true</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">                setUserConf(msg.uid,<span class=\"string\">&#x27;uid-help&#x27;</span>,<span class=\"literal\">true</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"string\">&quot;&#123;nick&#125;你的对象呢？\\n是这样用哒:\\n.repjoker uid &lt;QQ号&gt;\\n记住了以后可不会再告诉你了&quot;</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"string\">&quot;&#123;nick&#125;又没有对象了吗?&quot;</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">local</span> uid = getAtQQ(fitems[<span class=\"number\">2</span>])</span><br><span class=\"line\">            data = json.decode(<span class=\"built_in\">string</span>.<span class=\"built_in\">gsub</span>(default_data,<span class=\"string\">&#x27;%s&#x27;</span>,<span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">            <span class=\"keyword\">for</span> i=<span class=\"number\">1</span>,#data.uid_list <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(data.uid_list[i].uid == <span class=\"built_in\">tonumber</span>(uid)) <span class=\"keyword\">then</span></span><br><span class=\"line\">                    k = i</span><br><span class=\"line\">                    out = <span class=\"string\">&quot;已为&#123;nick&#125;找到&quot;</span>..getUserConf(<span class=\"built_in\">tonumber</span>(data.uid_list[k].uid),<span class=\"string\">&quot;nick#&quot;</span>)..<span class=\"string\">&quot;最近的一条发言记录:\\n&quot;</span>..stamp2Time(data.uid_list[k].<span class=\"built_in\">time</span>)..<span class=\"string\">&quot;:&quot;</span>..data.uid_list[k].msg</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                    out = <span class=\"string\">&quot;&#123;self&#125;处没有关于&quot;</span>.. getUserConf(<span class=\"built_in\">tonumber</span>(uid),<span class=\"string\">&quot;nick#&quot;</span>)..<span class=\"string\">&quot;的发言记录哦~&quot;</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> out</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span>(fitems[<span class=\"number\">1</span>] == <span class=\"string\">&quot;gid&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        default_data = <span class=\"string\">&quot;&#123;\\&quot;gid_list\\&quot;:[&quot;</span>..read_file(gid_path)..<span class=\"string\">&quot;]&#125;&quot;</span></span><br><span class=\"line\">        data = json.decode(default_data)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(fitems[<span class=\"number\">2</span>] == <span class=\"literal\">nil</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> getGroupConf(<span class=\"built_in\">tonumber</span>(msg.gid),<span class=\"string\">&quot;name&quot;</span>)..<span class=\"string\">&quot;(&quot;</span>..msg.gid..<span class=\"string\">&quot;)还没有人复读过哦~#期待&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">local</span> gid = getAtQQ(fitems[<span class=\"number\">2</span>])</span><br><span class=\"line\">            data = json.decode(<span class=\"built_in\">string</span>.<span class=\"built_in\">gsub</span>(default_data,<span class=\"string\">&#x27;%s&#x27;</span>,<span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">            <span class=\"keyword\">for</span> i=<span class=\"number\">1</span>,#data.msg <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(data.gid[i] == <span class=\"built_in\">tonumber</span>(gid)) <span class=\"keyword\">then</span></span><br><span class=\"line\">                    k = i</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                    out = <span class=\"string\">&quot;&#123;self&#125;处没有关于群&quot;</span>.. getGroupConf(<span class=\"built_in\">tonumber</span>(gid),<span class=\"string\">&quot;name&quot;</span>)..<span class=\"string\">&quot;(&quot;</span>..gid..<span class=\"string\">&quot;)的用户发言记录哦~&quot;</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> out</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span>(fitems[<span class=\"number\">1</span>] == <span class=\"string\">&quot;test&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        write_(msg.fromMsg,msg.uid,msg.fromGroup)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">write_</span><span class=\"params\">(str,uid,gid)</span></span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(gid == <span class=\"string\">&quot;0&quot;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        write_file(uid_path,<span class=\"string\">&quot;,&#123;\\&quot;uid\\&quot;:&quot;</span>..uid..<span class=\"string\">&quot;,\\&quot;msg\\&quot;:\\&quot;&quot;</span>..str..<span class=\"string\">&quot;\\&quot;,\\&quot;time\\&quot;:&quot;</span>..<span class=\"built_in\">os</span>.<span class=\"built_in\">time</span>()..<span class=\"string\">&quot;&#125;&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        write_file(gid_path,<span class=\"string\">&quot;,&#123;\\&quot;gid\\&quot;:&quot;</span>..gid..<span class=\"string\">&quot;,\\&quot;msg\\&quot;:\\&quot;&quot;</span>..str..<span class=\"string\">&quot;\\&quot;,\\&quot;time\\&quot;:&quot;</span>..<span class=\"built_in\">os</span>.<span class=\"built_in\">time</span>()..<span class=\"string\">&quot;&#125;&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure>\n","_path":"2022/07/14/repeat-joker/","_link":"https://cypress.github.io/2022/07/14/repeat-joker/","_id":"cl8x1d8bt000zkw49cgi33fvf"}}