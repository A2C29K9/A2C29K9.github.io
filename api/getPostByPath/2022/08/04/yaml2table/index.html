{"type":"getPostByPath","data":{"title":"yaml2table yaml转lua table","date":"2022-08-03T16:00:00.000Z","description":"","categories":[{"name":"技术","_id":"cl8t487uc000dbw4912dw47qv"},{"name":"Lua","_id":"cl8t487vn0017bw49eh72411a"}],"tags":[{"name":"Dice","_id":"cl8t487ub000cbw498hqe1qub"}],"content":"<div class=\"note success\"><p><strong>yaml2table</strong><br>简单实现读取yaml转为table,</p>\n<blockquote>\n<p>暂时不支持读取注释.</p>\n</blockquote>\n</div>\n\n\n<h3 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h3><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br><span class=\"line\">657</span><br><span class=\"line\">658</span><br><span class=\"line\">659</span><br><span class=\"line\">660</span><br><span class=\"line\">661</span><br><span class=\"line\">662</span><br><span class=\"line\">663</span><br><span class=\"line\">664</span><br><span class=\"line\">665</span><br><span class=\"line\">666</span><br><span class=\"line\">667</span><br><span class=\"line\">668</span><br><span class=\"line\">669</span><br><span class=\"line\">670</span><br><span class=\"line\">671</span><br><span class=\"line\">672</span><br><span class=\"line\">673</span><br><span class=\"line\">674</span><br><span class=\"line\">675</span><br><span class=\"line\">676</span><br><span class=\"line\">677</span><br><span class=\"line\">678</span><br><span class=\"line\">679</span><br><span class=\"line\">680</span><br><span class=\"line\">681</span><br><span class=\"line\">682</span><br><span class=\"line\">683</span><br><span class=\"line\">684</span><br><span class=\"line\">685</span><br><span class=\"line\">686</span><br><span class=\"line\">687</span><br><span class=\"line\">688</span><br><span class=\"line\">689</span><br><span class=\"line\">690</span><br><span class=\"line\">691</span><br><span class=\"line\">692</span><br><span class=\"line\">693</span><br><span class=\"line\">694</span><br><span class=\"line\">695</span><br><span class=\"line\">696</span><br><span class=\"line\">697</span><br><span class=\"line\">698</span><br><span class=\"line\">699</span><br><span class=\"line\">700</span><br><span class=\"line\">701</span><br><span class=\"line\">702</span><br><span class=\"line\">703</span><br><span class=\"line\">704</span><br><span class=\"line\">705</span><br><span class=\"line\">706</span><br><span class=\"line\">707</span><br><span class=\"line\">708</span><br><span class=\"line\">709</span><br><span class=\"line\">710</span><br><span class=\"line\">711</span><br><span class=\"line\">712</span><br><span class=\"line\">713</span><br><span class=\"line\">714</span><br><span class=\"line\">715</span><br><span class=\"line\">716</span><br><span class=\"line\">717</span><br><span class=\"line\">718</span><br><span class=\"line\">719</span><br><span class=\"line\">720</span><br><span class=\"line\">721</span><br><span class=\"line\">722</span><br><span class=\"line\">723</span><br><span class=\"line\">724</span><br><span class=\"line\">725</span><br><span class=\"line\">726</span><br><span class=\"line\">727</span><br><span class=\"line\">728</span><br><span class=\"line\">729</span><br><span class=\"line\">730</span><br><span class=\"line\">731</span><br><span class=\"line\">732</span><br><span class=\"line\">733</span><br><span class=\"line\">734</span><br><span class=\"line\">735</span><br><span class=\"line\">736</span><br><span class=\"line\">737</span><br><span class=\"line\">738</span><br><span class=\"line\">739</span><br><span class=\"line\">740</span><br><span class=\"line\">741</span><br><span class=\"line\">742</span><br><span class=\"line\">743</span><br><span class=\"line\">744</span><br><span class=\"line\">745</span><br><span class=\"line\">746</span><br><span class=\"line\">747</span><br><span class=\"line\">748</span><br><span class=\"line\">749</span><br><span class=\"line\">750</span><br><span class=\"line\">751</span><br><span class=\"line\">752</span><br><span class=\"line\">753</span><br><span class=\"line\">754</span><br><span class=\"line\">755</span><br><span class=\"line\">756</span><br><span class=\"line\">757</span><br><span class=\"line\">758</span><br><span class=\"line\">759</span><br><span class=\"line\">760</span><br><span class=\"line\">761</span><br><span class=\"line\">762</span><br><span class=\"line\">763</span><br><span class=\"line\">764</span><br><span class=\"line\">765</span><br><span class=\"line\">766</span><br><span class=\"line\">767</span><br><span class=\"line\">768</span><br><span class=\"line\">769</span><br><span class=\"line\">770</span><br><span class=\"line\">771</span><br><span class=\"line\">772</span><br><span class=\"line\">773</span><br><span class=\"line\">774</span><br><span class=\"line\">775</span><br><span class=\"line\">776</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\">-- tinyyaml - YAML subset parser</span></span><br><span class=\"line\"><span class=\"comment\">-------------------------------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">table</span> = <span class=\"built_in\">table</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">string</span> = <span class=\"built_in\">string</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> schar = <span class=\"built_in\">string</span>.<span class=\"built_in\">char</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> ssub, <span class=\"built_in\">gsub</span> = <span class=\"built_in\">string</span>.<span class=\"built_in\">sub</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">gsub</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> sfind, smatch = <span class=\"built_in\">string</span>.<span class=\"built_in\">find</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">match</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> tinsert, tremove = <span class=\"built_in\">table</span>.<span class=\"built_in\">insert</span>, <span class=\"built_in\">table</span>.<span class=\"built_in\">remove</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">setmetatable</span> = <span class=\"built_in\">setmetatable</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">pairs</span> = <span class=\"built_in\">pairs</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">type</span> = <span class=\"built_in\">type</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">tonumber</span> = <span class=\"built_in\">tonumber</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">math</span> = <span class=\"built_in\">math</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">getmetatable</span> = <span class=\"built_in\">getmetatable</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"built_in\">error</span> = <span class=\"built_in\">error</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> UNESCAPES = &#123;</span><br><span class=\"line\">  [<span class=\"string\">&#x27;0&#x27;</span>] = <span class=\"string\">&quot;\\x00&quot;</span>, z = <span class=\"string\">&quot;\\x00&quot;</span>, N    = <span class=\"string\">&quot;\\x85&quot;</span>,</span><br><span class=\"line\">  a = <span class=\"string\">&quot;\\x07&quot;</span>,     b = <span class=\"string\">&quot;\\x08&quot;</span>, t    = <span class=\"string\">&quot;\\x09&quot;</span>,</span><br><span class=\"line\">  n = <span class=\"string\">&quot;\\x0a&quot;</span>,     v = <span class=\"string\">&quot;\\x0b&quot;</span>, f    = <span class=\"string\">&quot;\\x0c&quot;</span>,</span><br><span class=\"line\">  r = <span class=\"string\">&quot;\\x0d&quot;</span>,     e = <span class=\"string\">&quot;\\x1b&quot;</span>, [<span class=\"string\">&#x27;\\\\&#x27;</span>] = <span class=\"string\">&#x27;\\\\&#x27;</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\">-- utils</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">select</span><span class=\"params\">(list, pred)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> selected = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i = <span class=\"number\">0</span>, #list <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> v = list[i]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> v <span class=\"keyword\">and</span> pred(v, i) <span class=\"keyword\">then</span></span><br><span class=\"line\">      tinsert(selected, v)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> selected</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">startswith</span><span class=\"params\">(haystack, needle)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> ssub(haystack, <span class=\"number\">1</span>, #needle) == needle</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ltrim</span><span class=\"params\">(str)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> smatch(str, <span class=\"string\">&quot;^%s*(.-)$&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">rtrim</span><span class=\"params\">(str)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> smatch(str, <span class=\"string\">&quot;^(.-)%s*$&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\">-- Implementation.</span></span><br><span class=\"line\"><span class=\"comment\">--</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> class = &#123;__meta=&#123;&#125;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">class.__meta.__call</span><span class=\"params\">(cls, ...)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> <span class=\"built_in\">self</span> = <span class=\"built_in\">setmetatable</span>(&#123;&#125;, cls)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> cls.__init <span class=\"keyword\">then</span></span><br><span class=\"line\">    cls.__init(<span class=\"built_in\">self</span>, ...)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">self</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">class.def</span><span class=\"params\">(base, typ, cls)</span></span></span><br><span class=\"line\">  base = base <span class=\"keyword\">or</span> class</span><br><span class=\"line\">  <span class=\"keyword\">local</span> mt = &#123;<span class=\"built_in\">__metatable</span>=base, <span class=\"built_in\">__index</span>=base&#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> k, v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(base.__meta) <span class=\"keyword\">do</span> mt[k] = v <span class=\"keyword\">end</span></span><br><span class=\"line\">  cls = <span class=\"built_in\">setmetatable</span>(cls <span class=\"keyword\">or</span> &#123;&#125;, mt)</span><br><span class=\"line\">  cls.<span class=\"built_in\">__index</span> = cls</span><br><span class=\"line\">  cls.<span class=\"built_in\">__metatable</span> = cls</span><br><span class=\"line\">  cls.__type = typ</span><br><span class=\"line\">  cls.__meta = mt</span><br><span class=\"line\">  <span class=\"keyword\">return</span> cls</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> types = &#123;</span><br><span class=\"line\">  null = class:def(<span class=\"string\">&#x27;null&#x27;</span>),</span><br><span class=\"line\">  map = class:def(<span class=\"string\">&#x27;map&#x27;</span>),</span><br><span class=\"line\">  omap = class:def(<span class=\"string\">&#x27;omap&#x27;</span>),</span><br><span class=\"line\">  <span class=\"built_in\">pairs</span> = class:def(<span class=\"string\">&#x27;pairs&#x27;</span>),</span><br><span class=\"line\">  set = class:def(<span class=\"string\">&#x27;set&#x27;</span>),</span><br><span class=\"line\">  seq = class:def(<span class=\"string\">&#x27;seq&#x27;</span>),</span><br><span class=\"line\">  timestamp = class:def(<span class=\"string\">&#x27;timestamp&#x27;</span>),</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> Null = types.null</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Null.__tostring</span><span class=\"params\">()</span></span> <span class=\"keyword\">return</span> <span class=\"string\">&#x27;yaml.null&#x27;</span> <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Null.isnull</span><span class=\"params\">(v)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> v == <span class=\"literal\">nil</span> <span class=\"keyword\">then</span> <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"built_in\">type</span>(v) == <span class=\"string\">&#x27;table&#x27;</span> <span class=\"keyword\">and</span> <span class=\"built_in\">getmetatable</span>(v) == Null <span class=\"keyword\">then</span> <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> null = Null()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">types.timestamp:__init</span><span class=\"params\">(y, m, d, h, i, s, f, z)</span></span></span><br><span class=\"line\">  <span class=\"built_in\">self</span>.year = <span class=\"built_in\">tonumber</span>(y)</span><br><span class=\"line\">  <span class=\"built_in\">self</span>.month = <span class=\"built_in\">tonumber</span>(m)</span><br><span class=\"line\">  <span class=\"built_in\">self</span>.day = <span class=\"built_in\">tonumber</span>(d)</span><br><span class=\"line\">  <span class=\"built_in\">self</span>.hour = <span class=\"built_in\">tonumber</span>(h <span class=\"keyword\">or</span> <span class=\"number\">0</span>)</span><br><span class=\"line\">  <span class=\"built_in\">self</span>.minute = <span class=\"built_in\">tonumber</span>(i <span class=\"keyword\">or</span> <span class=\"number\">0</span>)</span><br><span class=\"line\">  <span class=\"built_in\">self</span>.second = <span class=\"built_in\">tonumber</span>(s <span class=\"keyword\">or</span> <span class=\"number\">0</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"built_in\">type</span>(f) == <span class=\"string\">&#x27;string&#x27;</span> <span class=\"keyword\">and</span> sfind(f, <span class=\"string\">&#x27;^%d+$&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">self</span>.fraction = <span class=\"built_in\">tonumber</span>(f) * <span class=\"built_in\">math</span>.<span class=\"built_in\">pow</span>(<span class=\"number\">10</span>, <span class=\"number\">3</span> - #f)</span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> f <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">self</span>.fraction = f</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">self</span>.fraction = <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"built_in\">self</span>.timezone = z</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">types.timestamp:__tostring</span><span class=\"params\">()</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">string</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">    <span class=\"string\">&#x27;%04d-%02d-%02dT%02d:%02d:%02d.%03d%s&#x27;</span>,</span><br><span class=\"line\">    <span class=\"built_in\">self</span>.year, <span class=\"built_in\">self</span>.month, <span class=\"built_in\">self</span>.day,</span><br><span class=\"line\">    <span class=\"built_in\">self</span>.hour, <span class=\"built_in\">self</span>.minute, <span class=\"built_in\">self</span>.second, <span class=\"built_in\">self</span>.fraction,</span><br><span class=\"line\">    <span class=\"built_in\">self</span>:gettz())</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">types.timestamp:gettz</span><span class=\"params\">()</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> <span class=\"built_in\">self</span>.timezone <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"built_in\">self</span>.timezone == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;Z&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> sign = <span class=\"built_in\">self</span>.timezone &gt; <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> z = sign <span class=\"keyword\">and</span> <span class=\"built_in\">self</span>.timezone <span class=\"keyword\">or</span> -<span class=\"built_in\">self</span>.timezone</span><br><span class=\"line\">  <span class=\"keyword\">local</span> zh = <span class=\"built_in\">math</span>.<span class=\"built_in\">floor</span>(z)</span><br><span class=\"line\">  <span class=\"keyword\">local</span> zi = (z - zh) * <span class=\"number\">60</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">string</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">    <span class=\"string\">&#x27;%s%02d:%02d&#x27;</span>, sign <span class=\"keyword\">and</span> <span class=\"string\">&#x27;+&#x27;</span> <span class=\"keyword\">or</span> <span class=\"string\">&#x27;-&#x27;</span>, zh, zi)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">countindent</span><span class=\"params\">(line)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> _, j = sfind(line, <span class=\"string\">&#x27;^%s+&#x27;</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> j <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>, line</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> j, ssub(line, j+<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parsestring</span><span class=\"params\">(line, stopper)</span></span></span><br><span class=\"line\">  stopper = stopper <span class=\"keyword\">or</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> q = ssub(line, <span class=\"number\">1</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&#x27; &#x27;</span> <span class=\"keyword\">or</span> q == <span class=\"string\">&#x27;\\t&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> parsestring(ssub(line, <span class=\"number\">2</span>))</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&quot;&#x27;&quot;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> i = sfind(line, <span class=\"string\">&quot;&#x27;&quot;</span>, <span class=\"number\">2</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> i <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, line</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> ssub(line, <span class=\"number\">2</span>, i<span class=\"number\">-1</span>), ssub(line, i+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&#x27;&quot;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> i, buf = <span class=\"number\">2</span>, <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> i &lt; #line <span class=\"keyword\">do</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> c = ssub(line, i, i)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> c == <span class=\"string\">&#x27;\\\\&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> n = ssub(line, i+<span class=\"number\">1</span>, i+<span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> UNESCAPES[n] ~= <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">          buf = buf..UNESCAPES[n]</span><br><span class=\"line\">        <span class=\"keyword\">elseif</span> n == <span class=\"string\">&#x27;x&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">          <span class=\"keyword\">local</span> h = ssub(i+<span class=\"number\">2</span>,i+<span class=\"number\">3</span>)</span><br><span class=\"line\">          <span class=\"keyword\">if</span> sfind(h, <span class=\"string\">&#x27;^[0-9a-fA-F]$&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">            buf = buf..schar(<span class=\"built_in\">tonumber</span>(h, <span class=\"number\">16</span>))</span><br><span class=\"line\">            i = i + <span class=\"number\">2</span></span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">            buf = buf..<span class=\"string\">&#x27;x&#x27;</span></span><br><span class=\"line\">          <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          buf = buf..n</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        i = i + <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"keyword\">elseif</span> c == q <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        buf = buf..c</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      i = i + <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> buf, ssub(line, i+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&#x27;&#123;&#x27;</span> <span class=\"keyword\">or</span> q == <span class=\"string\">&#x27;[&#x27;</span> <span class=\"keyword\">then</span>  <span class=\"comment\">-- flow style</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, line</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&#x27;|&#x27;</span> <span class=\"keyword\">or</span> q == <span class=\"string\">&#x27;&gt;&#x27;</span> <span class=\"keyword\">then</span>  <span class=\"comment\">-- block</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, line</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> q == <span class=\"string\">&#x27;-&#x27;</span> <span class=\"keyword\">or</span> q == <span class=\"string\">&#x27;:&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ssub(line, <span class=\"number\">2</span>, <span class=\"number\">2</span>) == <span class=\"string\">&#x27; &#x27;</span> <span class=\"keyword\">or</span> #line == <span class=\"number\">1</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, line</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> buf = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> #line &gt; <span class=\"number\">0</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> c = ssub(line, <span class=\"number\">1</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> sfind(stopper, c, <span class=\"number\">1</span>, <span class=\"literal\">true</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;:&#x27;</span> <span class=\"keyword\">and</span> (ssub(line, <span class=\"number\">2</span>, <span class=\"number\">2</span>) == <span class=\"string\">&#x27; &#x27;</span> <span class=\"keyword\">or</span> #line == <span class=\"number\">1</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;#&#x27;</span> <span class=\"keyword\">and</span> (ssub(buf, #buf, #buf) == <span class=\"string\">&#x27; &#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      buf = buf..c</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> rtrim(buf), line</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isemptyline</span><span class=\"params\">(line)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> line == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> sfind(line, <span class=\"string\">&#x27;^%s*$&#x27;</span>) <span class=\"keyword\">or</span> sfind(line, <span class=\"string\">&#x27;^%s*#&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">equalsline</span><span class=\"params\">(line, needle)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> startswith(line, needle) <span class=\"keyword\">and</span> isemptyline(ssub(line, #needle+<span class=\"number\">1</span>))</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">checkdupekey</span><span class=\"params\">(map, key)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> map[key] ~= <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"comment\">-- print(&quot;found a duplicate key &#x27;&quot;..key..&quot;&#x27; in line: &quot;..line)</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> suffix = <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> map[key..<span class=\"string\">&#x27;_&#x27;</span>..suffix] <span class=\"keyword\">do</span></span><br><span class=\"line\">      suffix = suffix + <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    key = key ..<span class=\"string\">&#x27;_&#x27;</span>..suffix</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> key</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseflowstyle</span><span class=\"params\">(line, lines)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> stack = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> <span class=\"literal\">true</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> #line == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        line = tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> c = ssub(line, <span class=\"number\">1</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> c == <span class=\"string\">&#x27;#&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      line = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27; &#x27;</span> <span class=\"keyword\">or</span> c == <span class=\"string\">&#x27;\\t&#x27;</span> <span class=\"keyword\">or</span> c == <span class=\"string\">&#x27;\\r&#x27;</span> <span class=\"keyword\">or</span> c == <span class=\"string\">&#x27;\\n&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;&#123;&#x27;</span> <span class=\"keyword\">or</span> c == <span class=\"string\">&#x27;[&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      tinsert(stack, &#123;v=&#123;&#125;,t=c&#125;)</span><br><span class=\"line\">      line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;:&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> s = tremove(stack)</span><br><span class=\"line\">      tinsert(stack, &#123;v=s.v, t=<span class=\"string\">&#x27;:&#x27;</span>&#125;)</span><br><span class=\"line\">      line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;,&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> value = tremove(stack)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> value.t == <span class=\"string\">&#x27;:&#x27;</span> <span class=\"keyword\">or</span> value.t == <span class=\"string\">&#x27;&#123;&#x27;</span> <span class=\"keyword\">or</span> value.t == <span class=\"string\">&#x27;[&#x27;</span> <span class=\"keyword\">then</span> <span class=\"built_in\">error</span>() <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> stack[#stack].t == <span class=\"string\">&#x27;:&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"comment\">-- map</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> key = tremove(stack)</span><br><span class=\"line\">        key.v = checkdupekey(stack[#stack].v, key.v)</span><br><span class=\"line\">        stack[#stack].v[key.v] = value.v</span><br><span class=\"line\">      <span class=\"keyword\">elseif</span> stack[#stack].t == <span class=\"string\">&#x27;&#123;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"comment\">-- set</span></span><br><span class=\"line\">        stack[#stack].v[value.v] = <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"keyword\">elseif</span> stack[#stack].t == <span class=\"string\">&#x27;[&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"comment\">-- seq</span></span><br><span class=\"line\">        tinsert(stack[#stack].v, value.v)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;&#125;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> stack[#stack].t == <span class=\"string\">&#x27;&#123;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> #stack == <span class=\"number\">1</span> <span class=\"keyword\">then</span> <span class=\"keyword\">break</span> <span class=\"keyword\">end</span></span><br><span class=\"line\">        stack[#stack].t = <span class=\"string\">&#x27;&#125;&#x27;</span></span><br><span class=\"line\">        line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        line = <span class=\"string\">&#x27;,&#x27;</span>..line</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> c == <span class=\"string\">&#x27;]&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> stack[#stack].t == <span class=\"string\">&#x27;[&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> #stack == <span class=\"number\">1</span> <span class=\"keyword\">then</span> <span class=\"keyword\">break</span> <span class=\"keyword\">end</span></span><br><span class=\"line\">        stack[#stack].t = <span class=\"string\">&#x27;]&#x27;</span></span><br><span class=\"line\">        line = ssub(line, <span class=\"number\">2</span>)</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        line = <span class=\"string\">&#x27;,&#x27;</span>..line</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> s, rest = parsestring(line, <span class=\"string\">&#x27;,&#123;&#125;[]&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> s <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;invalid flowstyle line: &#x27;</span>..line)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      tinsert(stack, &#123;v=s, t=<span class=\"string\">&#x27;s&#x27;</span>&#125;)</span><br><span class=\"line\">      line = rest</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> stack[<span class=\"number\">1</span>].v, line</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseblockstylestring</span><span class=\"params\">(line, lines, indent)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>(<span class=\"string\">&quot;failed to find multi-line scalar content&quot;</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> s = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">local</span> firstindent = <span class=\"number\">-1</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> endline = <span class=\"number\">-1</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i = <span class=\"number\">1</span>, #<span class=\"built_in\">lines</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> ln = <span class=\"built_in\">lines</span>[i]</span><br><span class=\"line\">    <span class=\"keyword\">local</span> idt = countindent(ln)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> idt &lt;= indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ln == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      tinsert(s, <span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> firstindent == <span class=\"number\">-1</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        firstindent = idt</span><br><span class=\"line\">      <span class=\"keyword\">elseif</span> idt &lt; firstindent <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      tinsert(s, ssub(ln, firstindent + <span class=\"number\">1</span>))</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    endline = i</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">local</span> striptrailing = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> sep = <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> newlineatend = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> line == <span class=\"string\">&#x27;|&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">true</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> line == <span class=\"string\">&#x27;|+&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">false</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> line == <span class=\"string\">&#x27;|-&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">true</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> line == <span class=\"string\">&#x27;&gt;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">true</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27; &#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> line == <span class=\"string\">&#x27;&gt;+&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">false</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27; &#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> line == <span class=\"string\">&#x27;&gt;-&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    striptrailing = <span class=\"literal\">true</span></span><br><span class=\"line\">    sep = <span class=\"string\">&#x27; &#x27;</span></span><br><span class=\"line\">    newlineatend = <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;invalid blockstyle string:&#x27;</span>..line)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> eonl = <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i = #s, <span class=\"number\">1</span>, <span class=\"number\">-1</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> s[i] == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      tremove(s, i)</span><br><span class=\"line\">      eonl = eonl + <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> striptrailing <span class=\"keyword\">then</span></span><br><span class=\"line\">    eonl = <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> newlineatend <span class=\"keyword\">then</span></span><br><span class=\"line\">    eonl = eonl + <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i = endline, <span class=\"number\">1</span>, <span class=\"number\">-1</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    tremove(<span class=\"built_in\">lines</span>, i)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">table</span>.<span class=\"built_in\">concat</span>(s, sep)..<span class=\"built_in\">string</span>.<span class=\"built_in\">rep</span>(<span class=\"string\">&#x27;\\n&#x27;</span>, eonl)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parsetimestamp</span><span class=\"params\">(line)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> _, p1, y, m, d = sfind(line, <span class=\"string\">&#x27;^(%d%d%d%d)%-(%d%d)%-(%d%d)&#x27;</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> p1 <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, line</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> p1 == #line <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> types.timestamp(y, m, d), <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> _, p2, h, i, s = sfind(line, <span class=\"string\">&#x27;^[Tt ](%d+):(%d+):(%d+)&#x27;</span>, p1+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> p2 <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> types.timestamp(y, m, d), ssub(line, p1+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> p2 == #line <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> types.timestamp(y, m, d, h, i, s), <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> _, p3, f = sfind(line, <span class=\"string\">&#x27;^%.(%d+)&#x27;</span>, p2+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> p3 <span class=\"keyword\">then</span></span><br><span class=\"line\">    p3 = p2</span><br><span class=\"line\">    f = <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> zc = ssub(line, p3+<span class=\"number\">1</span>, p3+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">local</span> _, p4, zs, z = sfind(line, <span class=\"string\">&#x27;^ ?([%+%-])(%d+)&#x27;</span>, p3+<span class=\"number\">1</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> p4 <span class=\"keyword\">then</span></span><br><span class=\"line\">    z = <span class=\"built_in\">tonumber</span>(z)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> _, p5, zi = sfind(line, <span class=\"string\">&#x27;^:(%d+)&#x27;</span>, p4+<span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> p5 <span class=\"keyword\">then</span></span><br><span class=\"line\">      z = z + <span class=\"built_in\">tonumber</span>(zi) / <span class=\"number\">60</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    z = zs == <span class=\"string\">&#x27;-&#x27;</span> <span class=\"keyword\">and</span> -<span class=\"built_in\">tonumber</span>(z) <span class=\"keyword\">or</span> <span class=\"built_in\">tonumber</span>(z)</span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> zc == <span class=\"string\">&#x27;Z&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    p4 = p3 + <span class=\"number\">1</span></span><br><span class=\"line\">    z = <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    p4 = p3</span><br><span class=\"line\">    z = <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> types.timestamp(y, m, d, h, i, s, f, z), ssub(line, p4+<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parsescalar</span><span class=\"params\">(line, lines, indent)</span></span></span><br><span class=\"line\">  line = ltrim(line)</span><br><span class=\"line\">  line = <span class=\"built_in\">gsub</span>(line, <span class=\"string\">&#x27;^%s*#.*$&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>)  <span class=\"comment\">-- comment only -&gt; &#x27;&#x27;</span></span><br><span class=\"line\">  line = <span class=\"built_in\">gsub</span>(line, <span class=\"string\">&#x27;^%s*&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>)  <span class=\"comment\">-- trim head spaces</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> line == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> line == <span class=\"string\">&#x27;~&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> null</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">local</span> ts, _ = parsetimestamp(line)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ts <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> ts</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">local</span> s, _ = parsestring(line)</span><br><span class=\"line\">  <span class=\"comment\">-- startswith quote ... string</span></span><br><span class=\"line\">  <span class=\"comment\">-- not startswith quote ... maybe string</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> s <span class=\"keyword\">and</span> (startswith(line, <span class=\"string\">&#x27;&quot;&#x27;</span>) <span class=\"keyword\">or</span> startswith(line, <span class=\"string\">&quot;&#x27;&quot;</span>)) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> startswith(<span class=\"string\">&#x27;!&#x27;</span>, line) <span class=\"keyword\">then</span>  <span class=\"comment\">-- unexpected tagchar</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;unsupported line: &#x27;</span>..line)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> equalsline(line, <span class=\"string\">&#x27;&#123;&#125;&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> equalsline(line, <span class=\"string\">&#x27;[]&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> startswith(line, <span class=\"string\">&#x27;&#123;&#x27;</span>) <span class=\"keyword\">or</span> startswith(line, <span class=\"string\">&#x27;[&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> parseflowstyle(line, <span class=\"built_in\">lines</span>)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> startswith(line, <span class=\"string\">&#x27;|&#x27;</span>) <span class=\"keyword\">or</span> startswith(line, <span class=\"string\">&#x27;&gt;&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> parseblockstylestring(line, <span class=\"built_in\">lines</span>, indent)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">-- Regular unquoted string</span></span><br><span class=\"line\">  line = <span class=\"built_in\">gsub</span>(line, <span class=\"string\">&#x27;%s*#.*$&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>)  <span class=\"comment\">-- trim tail comment</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> v = line</span><br><span class=\"line\">  <span class=\"keyword\">if</span> v == <span class=\"string\">&#x27;null&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;Null&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;NULL&#x27;</span><span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> null</span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;true&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;True&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;TRUE&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;false&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;False&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;FALSE&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;.inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;.Inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;.INF&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">math</span>.<span class=\"built_in\">huge</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;+.inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;+.Inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;+.INF&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">math</span>.<span class=\"built_in\">huge</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;-.inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;-.Inf&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;-.INF&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> -<span class=\"built_in\">math</span>.<span class=\"built_in\">huge</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> v == <span class=\"string\">&#x27;.nan&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;.NaN&#x27;</span> <span class=\"keyword\">or</span> v == <span class=\"string\">&#x27;.NAN&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span> / <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> sfind(v, <span class=\"string\">&#x27;^[%+%-]?[0-9]+$&#x27;</span>) <span class=\"keyword\">or</span> sfind(v, <span class=\"string\">&#x27;^[%+%-]?[0-9]+%.$&#x27;</span>)<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">tonumber</span>(v)  <span class=\"comment\">-- : int</span></span><br><span class=\"line\">  <span class=\"keyword\">elseif</span> sfind(v, <span class=\"string\">&#x27;^[%+%-]?[0-9]+%.[0-9]+$&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">tonumber</span>(v)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> s <span class=\"keyword\">or</span> v</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> parsemap;  <span class=\"comment\">-- : func</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseseq</span><span class=\"params\">(line, lines, indent)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> seq = <span class=\"built_in\">setmetatable</span>(&#123;&#125;, types.seq)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> line ~= <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>()</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"comment\">-- Check for a new document</span></span><br><span class=\"line\">    line = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> startswith(line, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> startswith(<span class=\"built_in\">lines</span>, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">do</span></span><br><span class=\"line\">        tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> seq</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">-- Check the indent level</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> level = countindent(line)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> level &lt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> seq</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> level &gt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&quot;found bad indenting in line: &quot;</span>.. line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">local</span> i, j = sfind(line, <span class=\"string\">&#x27;%-%s+&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> i <span class=\"keyword\">then</span></span><br><span class=\"line\">      i, j = sfind(line, <span class=\"string\">&#x27;%-$&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> i <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> seq</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> rest = ssub(line, j+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> sfind(rest, <span class=\"string\">&#x27;^[^\\&#x27;\\&quot;%s]*:&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- Inline nested hash</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> indent2 = j</span><br><span class=\"line\">      <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>] = <span class=\"built_in\">string</span>.<span class=\"built_in\">rep</span>(<span class=\"string\">&#x27; &#x27;</span>, indent2)..rest</span><br><span class=\"line\">      tinsert(seq, parsemap(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2))</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> sfind(rest, <span class=\"string\">&#x27;^%-%s+&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- Inline nested seq</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> indent2 = j</span><br><span class=\"line\">      <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>] = <span class=\"built_in\">string</span>.<span class=\"built_in\">rep</span>(<span class=\"string\">&#x27; &#x27;</span>, indent2)..rest</span><br><span class=\"line\">      tinsert(seq, parseseq(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2))</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> isemptyline(rest) <span class=\"keyword\">then</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        tinsert(seq, null)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> seq</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;^%s*%-&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> nextline = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(nextline)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> indent2 == indent <span class=\"keyword\">then</span></span><br><span class=\"line\">          <span class=\"comment\">-- Null seqay entry</span></span><br><span class=\"line\">          tinsert(seq, null)</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          tinsert(seq, parseseq(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2))</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"comment\">-- - # comment</span></span><br><span class=\"line\">        <span class=\"comment\">--   key: value</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> nextline = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(nextline)</span><br><span class=\"line\">        tinsert(seq, parsemap(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2))</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> rest <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- Array entry with a value</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      tinsert(seq, parsescalar(rest, <span class=\"built_in\">lines</span>))</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> seq</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseset</span><span class=\"params\">(line, lines, indent)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> isemptyline(line) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;not seq line: &#x27;</span>..line)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> set = <span class=\"built_in\">setmetatable</span>(&#123;&#125;, types.set)</span><br><span class=\"line\">  <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"comment\">-- Check for a new document</span></span><br><span class=\"line\">    line = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> startswith(line, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> startswith(<span class=\"built_in\">lines</span>, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">do</span></span><br><span class=\"line\">        tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> set</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">-- Check the indent level</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> level = countindent(line)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> level &lt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> set</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> level &gt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&quot;found bad indenting in line: &quot;</span>.. line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">local</span> i, j = sfind(line, <span class=\"string\">&#x27;%?%s+&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> i <span class=\"keyword\">then</span></span><br><span class=\"line\">      i, j = sfind(line, <span class=\"string\">&#x27;%?$&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> i <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> set</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> rest = ssub(line, j+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> sfind(rest, <span class=\"string\">&#x27;^[^\\&#x27;\\&quot;%s]*:&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- Inline nested hash</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> indent2 = j</span><br><span class=\"line\">      <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>] = <span class=\"built_in\">string</span>.<span class=\"built_in\">rep</span>(<span class=\"string\">&#x27; &#x27;</span>, indent2)..rest</span><br><span class=\"line\">      set[parsemap(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2)] = <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> sfind(rest, <span class=\"string\">&#x27;^%s+$&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        tinsert(set, null)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> set</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;^%s*%?&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>])</span><br><span class=\"line\">        <span class=\"keyword\">if</span> indent2 == indent <span class=\"keyword\">then</span></span><br><span class=\"line\">          <span class=\"comment\">-- Null array entry</span></span><br><span class=\"line\">          set[null] = <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          set[parseseq(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2)] = <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> rest <span class=\"keyword\">then</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      set[parsescalar(rest, <span class=\"built_in\">lines</span>)] = <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&quot;failed to classify line: &quot;</span>..line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> set</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parsemap</span><span class=\"params\">(line, lines, indent)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> isemptyline(line) <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;not map line: &#x27;</span>..line)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> map = <span class=\"built_in\">setmetatable</span>(&#123;&#125;, types.map)</span><br><span class=\"line\">  <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"comment\">-- Check for a new document</span></span><br><span class=\"line\">    line = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> startswith(line, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> startswith(<span class=\"built_in\">lines</span>, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">do</span></span><br><span class=\"line\">        tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> map</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">-- Check the indent level</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> level, _ = countindent(line)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> level &lt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> map</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> level &gt; indent <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&quot;found bad indenting in line: &quot;</span>.. line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">-- Find the key</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> key</span><br><span class=\"line\">    <span class=\"keyword\">local</span> s, rest = parsestring(line)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">-- Quoted keys</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> s <span class=\"keyword\">and</span> startswith(rest, <span class=\"string\">&#x27;:&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> sc = parsescalar(s, &#123;&#125;, <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> sc <span class=\"keyword\">and</span> <span class=\"built_in\">type</span>(sc) ~= <span class=\"string\">&#x27;string&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        key = sc</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        key = s</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      line = ssub(rest, <span class=\"number\">2</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&quot;failed to classify line: &quot;</span>..line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    key = checkdupekey(map, key)</span><br><span class=\"line\">    line = ltrim(line)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ssub(line, <span class=\"number\">1</span>, <span class=\"number\">1</span>) == <span class=\"string\">&#x27;!&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- ignore type</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> rh = ltrim(ssub(line, <span class=\"number\">3</span>))</span><br><span class=\"line\">      <span class=\"keyword\">local</span> typename = smatch(rh, <span class=\"string\">&#x27;^!?[^%s]+&#x27;</span>)</span><br><span class=\"line\">      line = ltrim(ssub(rh, #typename+<span class=\"number\">1</span>))</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> isemptyline(line) <span class=\"keyword\">then</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      line = ltrim(line)</span><br><span class=\"line\">      map[key] = parsescalar(line, <span class=\"built_in\">lines</span>, indent)</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"comment\">-- An indent</span></span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        map[key] = null</span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;^%s*%-&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>])</span><br><span class=\"line\">        map[key] = parseseq(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2)</span><br><span class=\"line\">      <span class=\"keyword\">elseif</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;^%s*%?&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>])</span><br><span class=\"line\">        map[key] = parseset(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2)</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> indent2 = countindent(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>])</span><br><span class=\"line\">        <span class=\"keyword\">if</span> indent &gt;= indent2 <span class=\"keyword\">then</span></span><br><span class=\"line\">          <span class=\"comment\">-- Null hash entry</span></span><br><span class=\"line\">          map[key] = null</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          map[key] = parsemap(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, indent2)</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> map</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- : (list&lt;str&gt;)-&gt;dict</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parsedocuments</span><span class=\"params\">(lines)</span></span></span><br><span class=\"line\">  <span class=\"built_in\">lines</span> = <span class=\"built_in\">select</span>(<span class=\"built_in\">lines</span>, <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(s)</span></span> <span class=\"keyword\">return</span> <span class=\"keyword\">not</span> isemptyline(s) <span class=\"keyword\">end</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;^%%YAML&#x27;</span>) <span class=\"keyword\">then</span> tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>) <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">local</span> root = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">local</span> in_document = <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> line = <span class=\"built_in\">lines</span>[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"comment\">-- Do we have a document header?</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> docright;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> sfind(line, <span class=\"string\">&#x27;^%-%-%-&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- Handle scalar documents</span></span><br><span class=\"line\">      docright = ssub(line, <span class=\"number\">4</span>)</span><br><span class=\"line\">      tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      in_document = <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> docright <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">not</span> sfind(docright, <span class=\"string\">&#x27;^%s+$&#x27;</span>) <span class=\"keyword\">and</span></span><br><span class=\"line\">          <span class=\"keyword\">not</span> sfind(docright, <span class=\"string\">&#x27;^%s+#&#x27;</span>)) <span class=\"keyword\">then</span></span><br><span class=\"line\">        tinsert(root, parsescalar(docright, <span class=\"built_in\">lines</span>))</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> #<span class=\"built_in\">lines</span> == <span class=\"number\">0</span> <span class=\"keyword\">or</span> startswith(line, <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- A naked document</span></span><br><span class=\"line\">      tinsert(root, null)</span><br><span class=\"line\">      <span class=\"keyword\">while</span> #<span class=\"built_in\">lines</span> &gt; <span class=\"number\">0</span> <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> sfind(<span class=\"built_in\">lines</span>[<span class=\"number\">1</span>], <span class=\"string\">&#x27;---&#x27;</span>) <span class=\"keyword\">do</span></span><br><span class=\"line\">        tremove(<span class=\"built_in\">lines</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      in_document = <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"comment\">-- XXX The final &#x27;-+$&#x27; is to look for -- which ends up being an</span></span><br><span class=\"line\">    <span class=\"comment\">-- error later.</span></span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> <span class=\"keyword\">not</span> in_document <span class=\"keyword\">and</span> #root &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- only the first document can be explicit</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;parse error: &#x27;</span>..line)</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> sfind(line, <span class=\"string\">&#x27;^%s*%-&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- An array at the root</span></span><br><span class=\"line\">      tinsert(root, parseseq(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\">    <span class=\"keyword\">elseif</span> sfind(line, <span class=\"string\">&#x27;^%s*[^%s]&#x27;</span>) <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\">-- A hash at the root</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> level = countindent(line)</span><br><span class=\"line\">      tinsert(root, parsemap(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"built_in\">lines</span>, level))</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"comment\">-- Shouldn&#x27;t get here.  @lines have whitespace-only lines</span></span><br><span class=\"line\">      <span class=\"comment\">-- stripped, and previous match is a line with any</span></span><br><span class=\"line\">      <span class=\"comment\">-- non-whitespace.  So this clause should only be reachable via</span></span><br><span class=\"line\">      <span class=\"comment\">-- a perlbug where \\s is not symmetric with \\S</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">-- uncoverable statement</span></span><br><span class=\"line\">      <span class=\"built_in\">error</span>(<span class=\"string\">&#x27;parse error: &#x27;</span>..line)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> #root &gt; <span class=\"number\">1</span> <span class=\"keyword\">and</span> Null.isnull(root[<span class=\"number\">1</span>]) <span class=\"keyword\">then</span></span><br><span class=\"line\">    tremove(root, <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> root</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> root</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--- Parse yaml string into table.</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parse</span><span class=\"params\">(source)</span></span></span><br><span class=\"line\">  <span class=\"keyword\">local</span> <span class=\"built_in\">lines</span> = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> <span class=\"built_in\">string</span>.<span class=\"built_in\">gmatch</span>(source .. <span class=\"string\">&#x27;\\n&#x27;</span>, <span class=\"string\">&#x27;(.-)\\r?\\n&#x27;</span>) <span class=\"keyword\">do</span></span><br><span class=\"line\">    tinsert(<span class=\"built_in\">lines</span>, line)</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">local</span> docs = parsedocuments(<span class=\"built_in\">lines</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> #docs == <span class=\"number\">1</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> docs[<span class=\"number\">1</span>]</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> docs</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">  version = <span class=\"number\">0.1</span>,</span><br><span class=\"line\">  parse = parse,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","_path":"2022/08/04/yaml2table/","_link":"https://cypress.github.io/2022/08/04/yaml2table/","_id":"cl8t487vq001cbw49drq3bkg5"}}